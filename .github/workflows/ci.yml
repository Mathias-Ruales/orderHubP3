name: CI - OrderHub

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  lint_test_build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ---------- Lint/Test (si existen scripts) ----------
      - name: Install & test order-service
        working-directory: infra/services/order-service
        run: |
          npm ci
          npm run lint --if-present
          npm test --if-present

      - name: Install & test inventory-service
        working-directory: infra/services/inventory-service
        run: |
          npm ci
          npm run lint --if-present
          npm test --if-present

      - name: Install & test notification-service
        working-directory: infra/services/notification-service
        run: |
          npm ci
          npm run lint --if-present
          npm test --if-present

      - name: Install & test billing-function
        working-directory: infra/services/billing-function
        run: |
          npm ci
          npm run lint --if-present
          npm test --if-present

      # ---------- Docker Build ----------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (services)
        run: |
          docker build -t orderhub/order-service:ci infra/services/order-service
          docker build -t orderhub/inventory-service:ci infra/services/inventory-service
          docker build -t orderhub/notification-service:ci infra/services/notification-service
          docker build -t orderhub/billing-function:ci infra/services/billing-function

  compose_smoke:
    runs-on: ubuntu-latest
    needs: lint_test_build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start stack (docker compose)
        working-directory: infra
        run: |
          docker compose --env-file .env -f docker-compose.yml up -d
          docker compose --env-file .env -f docker-compose.yml -f docker-compose.apps.yml up -d --build

      - name: Wait a bit
        run: sleep 10

      - name: Smoke check /health through Kong
        run: |
          curl -sSf http://localhost:8000/health

      - name: Show running containers (debug)
        if: always()
        run: |
          docker ps

      - name: Tear down
        if: always()
        working-directory: infra
        run: |
          docker compose -f docker-compose.yml -f docker-compose.apps.yml down -v